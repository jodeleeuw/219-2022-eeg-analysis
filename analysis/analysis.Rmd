---
title: "A replication of Coulson & Williams (2005)"
output: rticles::plos_article
---

```{r Load Libraries, include=FALSE}
library(dplyr)
library(jsonlite)
library(readr)
library(stringr)
library(ggplot2)
library(tidyr)
```


# Methods

# Results

## Behavioral

```{r Load Behavioral Data, include=FALSE}
json.files <- list.files(path="data", pattern=".json", full.names = TRUE)
experiment.data <- lapply(json.files, fromJSON) %>% bind_rows()

naming.data <- read_csv("data/verbal_responses_EEG_2022.csv")
```

```{r Create merged naming data, include=FALSE}
trial.info <- experiment.data %>%
  filter(task == "test-response") %>%
  select(subject_id, left_or_right, sentence_type) %>%
  group_by(subject_id) %>%
  mutate(trial = 1:n()) %>%
  mutate(subject_id = if_else(subject_id == "19\\", "19", subject_id))

merged.naming.data <- naming.data %>%
  mutate(subject_id = str_pad(as.character(subject), 2, side="left", pad="0")) %>%
  left_join(trial.info, by=c("subject_id", "trial")) %>%
  select(subject_id, trial, left_or_right, sentence_type, correct)

write_csv(merged.naming.data, file="data/delayed_naming.csv")
```

### Delayed Naming Task

```{r Compute Delayed Naming Accuracy, include=FALSE}
delayed.naming.subject.data <- merged.naming.data %>%
  group_by(subject_id, left_or_right, sentence_type) %>%
  summarize(m.subject = mean(correct))

delayed.naming.data <- delayed.naming.subject.data %>%
  group_by(left_or_right, sentence_type) %>%
  summarize(m = mean(m.subject), se=sd(m.subject) / sqrt(n()))
```

```{r Plot Delayed Naming Accuracy, echo=FALSE}
ggplot(delayed.naming.data, aes(x=sentence_type, y=m, ymin=m-se, ymax=m+se, color=left_or_right))+
  geom_pointrange(position= position_dodge(width=0.25))+
  labs(x="Sentence Type", y="Proportion Correct", color="Visual Field")+
  theme_bw()
```

## EEG

```{r Load EEG data, include=FALSE}
eeg.data <- readRDS("data/eeg/epochs/epochs.rds")

eeg.data <- eeg.data %>%
  mutate(ending = case_when(
    event_type %in% c(1,4) ~ "filler",
    event_type %in% c(2,5) ~ "joke",
    event_type %in% c(3,6) ~ "nonjoke",
    event_type %in% c(7,8) ~ "practice",
  )) %>%
  mutate(visual_field = case_when(
    event_type %in% c(1,2,3,7) ~ "left",
    event_type %in% c(4,5,6,8) ~ "right"
  ))
```

### N1

```{r N1 data, include=FALSE}
n1.data <- eeg.data %>%
  filter(electrode %in% c("P7", "P8", "O1", "O2")) %>%
  filter(ending != "practice") %>%
  mutate(hemisphere = if_else(electrode %in% c("P7", "O1"), "left", "right"))
```

```{r N1 ERPs, include=FALSE}
n1.erps <- n1.data %>%
  filter(good_segment == TRUE) %>%
  group_by(subject, electrode, visual_field, t) %>%
  summarize(mean.v = mean(v))

n1.erps.grand.average <- n1.erps %>%
  group_by(electrode, visual_field, t) %>%
  summarize(m = mean(mean.v), se=sd(mean.v)/sqrt(n()))
```

```{r Plot N1 ERPs, echo=FALSE}
ggplot(n1.erps.grand.average, aes(x=t, y=m, ymin=m-se, ymax=m+se, color=visual_field, fill=visual_field))+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  geom_ribbon(color=NA, alpha=0.2)+
  geom_line(size=0.8)+
  #coord_cartesian(xlim=c(-100,500))+
  facet_wrap(~electrode)+
  theme_minimal()+
  theme(panel.grid = element_blank())
```

### N400

```{r Filter N400 data, include=FALSE}
n4.data <- eeg.data %>%
  filter(electrode %in% c("P3", "P4", "Pz")) %>%
  filter(ending != "practice")
```

```{r Subject N400 ERPs, include=FALSE}
n4.erps <- n4.data %>%
  filter(good_segment == TRUE) %>%
  group_by(subject, ending, visual_field, t) %>%
  summarize(mean.v = mean(v))
```

```{r Grand Average N400 ERPs, include=FALSE}
n4.erps.grand.average <- n4.erps %>%
  group_by(ending, visual_field, t) %>%
  summarize(m = mean(mean.v), se=sd(mean.v) / sqrt(n()))
```

```{r Plot N400 ERP, echo=FALSE}
ggplot(n4.erps.grand.average, aes(x=t, y=m, ymin=m-se, ymax=m+se, color=ending, fill=ending))+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  geom_ribbon(color=NA, alpha=0.2)+
  geom_line(size=0.8)+
  #coord_cartesian(xlim=c(-100,500))+
  facet_wrap(~visual_field)+
  theme_minimal()+
  theme(panel.grid = element_blank())
```

```{r Calculate N400 difference waves, include=FALSE}
n4.difference.waves <- n4.erps %>%
  pivot_wider(names_from = ending, values_from = mean.v) %>%
  mutate(joke.filler.diff = joke - filler) %>%
  mutate(nonjoke.filler.diff = nonjoke - filler) %>%
  select(-joke, -filler, -nonjoke) %>%
  pivot_longer(c('joke.filler.diff', 'nonjoke.filler.diff'), names_to = "ending", values_to = "diff.v")
```

```{r Calculate grand average N400 difference waves, include=FALSE}
n4.difference.waves.grand.average <- n4.difference.waves %>%
  group_by(ending, visual_field, t) %>%
  summarize(m = mean(diff.v), se=sd(diff.v) / sqrt(n()))
```

```{r Plot Difference Waves N400, echo=FALSE}
ggplot(n4.difference.waves.grand.average, aes(x=t, y=m, ymin=m-se, ymax=m+se, color=ending, fill=ending))+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  geom_ribbon(color=NA, alpha=0.2)+
  geom_line(size=0.8)+
  #coord_cartesian(xlim=c(-100,500))+
  facet_wrap(~visual_field)+
  theme_minimal()+
  theme(panel.grid = element_blank())
```